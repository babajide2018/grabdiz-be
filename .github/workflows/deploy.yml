name: Deploy Backend to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, bcmath, pdo, pdo_mysql, fileinfo, gd, zip
          coverage: none

      - name: Setup Composer
        uses: php-actions/composer@v6
        with:
          php_version: '8.2'

      - name: Install Composer dependencies
        run: |
          # Note: We don't need to install dependencies in GitHub Actions
          # since vendor is excluded from rsync deployment.
          # Dependencies will be installed on the server.
          # However, if composer.json validation is needed, we can run:
          echo "üìã Validating composer.json..."
          composer validate --no-check-publish || true
          echo "‚úÖ Skipping local dependency installation (will install on server)"

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 21098 server254.web-hosting.com >> ~/.ssh/known_hosts

      - name: Deploy Backend to Server
        run: |
          DEPLOY_PATH="~/api.grabdiz.co.uk"
          echo "üì¶ Deploying Laravel Backend to: $DEPLOY_PATH"
          
          # Backup .env file on server before deployment (if it exists)
          echo "üíæ Backing up existing .env file on server..."
          ssh -p 21098 scepgtce@server254.web-hosting.com "
            cd $DEPLOY_PATH
            if [ -f .env ]; then
              cp .env .env.backup.\$(date +%Y%m%d_%H%M%S)
              echo '‚úÖ .env backed up'
            else
              echo '‚ö†Ô∏è  No .env file found to backup'
            fi
          "
          
          # Deploy backend files (excluding sensitive files)
          # IMPORTANT: .env is excluded to prevent overwriting server configuration
          rsync -avz \
            -e "ssh -p 21098" \
            --exclude 'vendor' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude '.env.backup' \
            --exclude '.env.production' \
            --exclude '.env.local' \
            --exclude 'node_modules' \
            --exclude 'storage/logs/*.log' \
            --exclude '.env.backup.*' \
            --exclude 'bootstrap/cache/*' \
            --exclude 'storage/framework/cache/*' \
            --exclude 'storage/framework/sessions/*' \
            --exclude 'storage/framework/views/*' \
            --exclude 'database/database.sqlite' \
            ./ scepgtce@server254.web-hosting.com:$DEPLOY_PATH/
          
          # Restore .env file if it was backed up (in case rsync somehow removed it)
          echo "üîí Verifying and restoring .env file if needed..."
          ssh -p 21098 scepgtce@server254.web-hosting.com "
            cd $DEPLOY_PATH
            if [ ! -f .env ]; then
              echo '‚ö†Ô∏è  .env file is missing after deployment!'
              # Try to restore from most recent backup
              LATEST_BACKUP=\$(ls -t .env.backup.* 2>/dev/null | head -1)
              if [ -n \"\$LATEST_BACKUP\" ]; then
                cp \"\$LATEST_BACKUP\" .env
                echo '‚úÖ .env restored from backup: \$LATEST_BACKUP'
              else
                echo '‚ùå ERROR: .env file is missing and no backup found!'
                echo '‚ö†Ô∏è  You may need to manually create .env file on the server'
                exit 1
              fi
            else
              echo '‚úÖ .env file is safe and exists on server'
              # Verify it's not empty
              if [ ! -s .env ]; then
                echo '‚ö†Ô∏è  WARNING: .env file exists but is empty!'
                # Try to restore from backup
                LATEST_BACKUP=\$(ls -t .env.backup.* 2>/dev/null | head -1)
                if [ -n \"\$LATEST_BACKUP\" ]; then
                  cp \"\$LATEST_BACKUP\" .env
                  echo '‚úÖ .env restored from backup (was empty)'
                fi
              fi
            fi
          "
          
          echo "üîß Installing Composer dependencies on server..."
          ssh -p 21098 scepgtce@server254.web-hosting.com "
            cd $DEPLOY_PATH
            if [ -f composer.json ]; then
              echo 'üßπ Cleaning vendor directory if it exists...'
              if [ -d vendor ]; then
                # Make files writable before removal
                chmod -R u+w vendor 2>/dev/null || true
                rm -rf vendor || {
                  echo '‚ö†Ô∏è  Could not remove vendor directory, continuing with composer install...'
                }
              fi
              echo 'üì¶ Running composer install in $DEPLOY_PATH...'
              composer install --no-dev --optimize-autoloader --no-interaction
              if [ \$? -eq 0 ]; then
                echo '‚úÖ Composer dependencies installed successfully'
              else
                echo '‚ùå ERROR: composer install failed!'
                exit 1
              fi
            else
              echo '‚ö†Ô∏è  composer.json not found in $DEPLOY_PATH'
              exit 1
            fi
          " || {
            echo "‚ùå ERROR: Failed to install Composer dependencies"
            exit 1
          }
          
          echo "üîó Creating storage symlink..."
          ssh -p 21098 scepgtce@server254.web-hosting.com "
            cd $DEPLOY_PATH
            # Use full PHP path to avoid cPanel EA4 wrapper issues
            if [ ! -L public/storage ]; then
              /usr/local/bin/php artisan storage:link
              echo '‚úÖ Storage symlink created'
            else
              echo '‚úÖ Storage symlink already exists'
            fi
          "
          
          echo "‚úÖ Backend deployment completed successfully!"

